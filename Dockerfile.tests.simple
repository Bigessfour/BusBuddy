# Use the .NET SDK image for building the tests
FROM mcr.microsoft.com/dotnet/sdk:6.0

WORKDIR /app

# Install curl for health checks
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Copy csproj and restore dependencies
COPY *.sln .
COPY Directory.Packages.props .
COPY global.json .
COPY BusBuddy.csproj .
COPY Tests/BusBuddy.Tests.csproj Tests/
COPY Tests/Directory.Build.props Tests/

# Create isolated test project for non-UI tests
RUN mkdir -p /app/SimpleTests
WORKDIR /app/SimpleTests
RUN dotnet new xunit -o BusBuddy.SimpleTests
WORKDIR /app/SimpleTests/BusBuddy.SimpleTests

# Add necessary packages  
RUN dotnet add package Moq
RUN dotnet add package Microsoft.EntityFrameworkCore.InMemory
RUN dotnet add package Microsoft.Extensions.Logging
RUN dotnet add package Microsoft.Extensions.DependencyInjection

# Create a smoke test file
WORKDIR /app/SimpleTests/BusBuddy.SimpleTests
RUN echo 'using Xunit; \n\
using System; \n\
using System.Collections.Generic; \n\
using System.Linq; \n\
using Microsoft.Extensions.DependencyInjection; \n\
\n\
namespace BusBuddy.SimpleTests \n\
{ \n\
    public class DockerContainerTests \n\
    { \n\
        [Fact] \n\
        public void CanRunTestsInDocker() \n\
        { \n\
            Assert.True(true, "Docker container can run basic tests"); \n\
        } \n\
        \n\
        [Fact] \n\
        public void DependencyInjectionWorks() \n\
        { \n\
            // Verify DI system works properly \n\
            var services = new ServiceCollection(); \n\
            services.AddLogging(); \n\
            services.AddSingleton<TestService>(); \n\
            \n\
            var provider = services.BuildServiceProvider(); \n\
            var service = provider.GetRequiredService<TestService>(); \n\
            \n\
            Assert.NotNull(service); \n\
            Assert.Equal("Test Value", service.GetValue()); \n\
        } \n\
    } \n\
    \n\
    public class TestService \n\
    { \n\
        public string GetValue() => "Test Value"; \n\
    } \n\
}' > DockerContainerTests.cs

# Build and run the tests
WORKDIR /app/SimpleTests/BusBuddy.SimpleTests
ENTRYPOINT ["dotnet", "test", "--verbosity", "normal"]
